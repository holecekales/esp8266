<!DOCTYPE html>
<html>
<title>File Upload</title>

<head>
    <style>
        ::-webkit-scrollbar {
            -webkit-appearance: none;
            width: 12px;
        }

        ::-webkit-scrollbar-thumb {
            border-radius: 4px;
            background-color: rgb(80, 80, 80);
            box-shadow: 0 0 1px rgba(255, 255, 255, .5);
        }

        body {
            margin: 0px;
            height: 100%;
            font-family: 'Segoe UI', 'Tahoma', 'Geneva', 'Verdana', sans-serif;
        }

        .box {
            background-color: #444;
            color: #fff;
            width: 100%;
            height: 100%;
        }

        .header {
            padding-left: 20px;
            grid-area: header;
            background-color: #2c3e50;
            font-size: 120%;
            display: flex;
            align-items: center;
        }

        .tools {
            grid-area: tools;
            position: relative;
        }

        .sidebar {
            grid-area: sidebar;
            position: absolute;
        }

        .content {
            grid-area: content;
        }

        .fooder {
            grid-area: fooder;
            padding-left: 20px;
            display: flex;
            align-items: center;
            font-size: 80%;
        }

        .wrapper {
            display: grid;
            grid-template-columns: 150px auto;
            grid-template-rows: 50px max-content auto 30px;
            grid-template-areas: "header header" "tools content" "sidebar content" "fooder fooder";
            grid-gap: 2px;
            background-color: #777;
            position: absolute;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            overflow: hidden;
        }

        #editor {
            position: relative;
            height: 100%;
            width: 100%;
            overflow: hidden;
            display: block;
        }

        #fileListContainer {
            width: 100%;
            height: 100%;
            /* float: left; add this */
            display: block;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
            background-color: rgb(143, 142, 142)
        }

        /* Overwrite the default to keep the scrollbar always visible */

        input[type="file"] {
            display: none;
        }

        .custom-file-upload {
            /* border: 1px solid black; */
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
        }

        ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            width: 200px;
            height: 100%
        }

        li a {
            display: block;
            color: #000;
            padding: 8px 16px;
            text-decoration: none;
        }

        /* Change the link color on hover */

        li a:hover {
            background-color: rgb(130, 130, 130);
            color: black;
        }

        li a.active {
            background-color: rgb(130, 130, 130);
            color: white
        }

        .ace_scrollbar-inner {
            background-color: white;
            opacity: 0.5;
        }
    </style>

    <script>

        function setActive(activeElem) {
            var elems = document.querySelectorAll("li a");
            elems.forEach((e) => {
                if(e == activeElem)
                    e.classList.add("active");
                else
                    e.classList.remove("active");
            });
        }
        function listClick(ev) {
            load(ev.target.href, (r) => {
                editor.getSession().setValue(r);
            });
            setActive(ev.target);
            ev.preventDefault();
        }

        function getFileList(fl) {
            var productList = JSON.parse(fl);
            var ul = document.querySelector('#fileList');
            while (ul.firstChild) {
                ul.removeChild(ul.firstChild);
            }
            productList.forEach((elemName) => {
                var li = document.createElement('li');
                var a = document.createElement("a");
                a.addEventListener('click', listClick);
                a.setAttribute('href', elemName.url);
                a.innerHTML = elemName.name;
                li.appendChild(a);
                ul.appendChild(li);
            });
        }

        function load(url, callback) {
            var xhr = new XMLHttpRequest();
            var debug = document.querySelector("#dump");
            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    if (xhr.status == 200) { }
                    else
                        debug.innerHTML += " -- Error " + xhr.status;

                    callback(xhr.response);
                }
            }
            xhr.open('GET', url, true);
            xhr.send('');

            var i = url.lastIndexOf('.');
            var ext = i < 0 ? "" : url.substr(i + 1);

            if (ext == "" || ext == "txt") ext = "text";
            else if (ext == 'md') ext = 'markdown';
            else if (ext == "js") ext = 'javascript';
            else if (ext == 'ts') ext = 'typescript';
            else if (ext == 'ino') ext = 'c_cpp';

            editor.getSession().setMode("ace/mode/" + ext);
            debug.innerHTML = "Mode: " + ext + "      " + url;
        }    
    </script>

</head>

<body>

    <div class="wrapper">
        <div class="box header">ESP8266 Console</div>

        <div class="box tools">

            <form enctype="multipart/form-data" method="post" name="fileUploader">
                <label class="custom-file-upload">
                    <input type="file" name="file" multiple/>Add New
                </label>
            </form>
        </div>

        <div class="box sidebar">
            <div id="fileListContainer">
                <ul id="fileList">
                </ul>
            </div>

        </div>

        <div class="box content">
            <div id="editor"></div>
        </div>

        <div class="box fooder">
            <div id="dump"></div>
        </div>
    </div>

    <script src="//ajaxorg.github.io/ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script>
        // form submission
        var form = document.forms.namedItem("fileUploader");
        form.addEventListener('change', (ev) => {
            var oOutput = document.querySelector("#dump"),
                oData = new FormData(form);

            oData.append("CustomField", "This is some extra data");

            var oReq = new XMLHttpRequest();
            oReq.open("POST", "/upload", true);
            oReq.onload = function (oEvent) {
                if (oReq.status == 200) {
                    oOutput.innerHTML = "Uploaded!";
                    load('/upload', getFileList);
                }
                else
                    oOutput.innerHTML = "Error " + oReq.status + " occurred when trying to upload your file.<br \/>";
            };
            oReq.send(oData);
            ev.preventDefault();
        }, false);

        // handling of the editor
        var editor = ace.edit("editor");
        editor.getSession().setUseWorker(false);
        editor.setTheme("ace/theme/monokai");
        editor.setShowPrintMargin(false);
        // editor.setTheme("ace/theme/twilight");
        editor.getSession().setMode("ace/mode/javascript");
        editor.commands.addCommand({
            name: 'save',
            bindKey: { win: 'Ctrl-S', mac: 'Command-S' },
            exec: function (editor) {
                alert("Save");
            }
        });

        load('/upload', getFileList);

    </script>

</body>

</html>